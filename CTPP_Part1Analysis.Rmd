---
title: "CTPP_Part1Analysis"
author: "Alex Karner"
date: "June 10, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This markdown file demonstrates how to conduct a basic analysis of mode share
at the tract level using CTPP Part 1 data. You must first have downloaded the 
necessary data and created a MonetDB database using MonetDBLite. 

```{r warning = FALSE, message = FALSE}
library(DBI)
library(ggplot2)
library(dplyr)
library(tigris)
library(tidyr)
```

# Table A102106 - Means of transportation
## Extract data for Harris County, TX

```{r}
# Connect to the MonetDB database containing CTPP data
dbdir <- "monet_ctpp"
con <- dbConnect(MonetDBLite::MonetDBLite(), dbdir)

harris_res <- dbGetQuery(con, "SELECT * FROM harrisres")

# https://stackoverflow.com/questions/28100780/use-with-replacement-functions-like-colnames
harris_res_wide <- harris_res %>%
  select(geoid10, lineno, est) %>%
  spread(lineno, est, fill = 0) %>%
   `colnames<-`(c("geoid10", "total", "da", "cp2", "cp3", "cp4", "cp56", "cp7p", 
             "bus", "streetcar", "subway", "railroad", "ferry", "bike", "walk",
             "taxi", "motorcycle", "other", "telecommute")) %>%
  mutate(carpool = cp2 + cp3 + cp4 + cp56 + cp7p,
         transit = bus + streetcar + subway,
         dashare = da / total,
         transhare = transit / total)
```

The Harris County data can subsequently be combined with spatial data from
the census to map patterns of public transit use, e.g.

```{r}
# Retreive Harris county tracts from tigris
tracts_harris <- tracts("TX", county = "201")

# Join and map part 1 data 
tracts_wgeo <- inner_join(tracts_harris, harris_res_wide,
                            by = c("GEOID" = "geoid10"))

ggplot() + geom_sf(data = tracts_wgeo, aes(fill = transhare))

dbDisconnect(con, shutdown = TRUE)
```


